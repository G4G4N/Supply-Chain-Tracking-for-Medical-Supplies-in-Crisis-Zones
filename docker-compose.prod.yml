# @Author: Mukhil Sundararaj
# @Date:   2025-11-25 17:39:03
# @Last Modified by:   Mukhil Sundararaj
# @Last Modified time: 2025-11-25 17:44:14
version: '3.8'

services:
  dapp:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        REACT_APP_CONTRACT_ADDRESS: ${REACT_APP_CONTRACT_ADDRESS}
        REACT_APP_NETWORK: ${REACT_APP_NETWORK:-mainnet}
        REACT_APP_ENABLE_ANALYTICS: ${REACT_APP_ENABLE_ANALYTICS:-true}
        REACT_APP_ENABLE_ERROR_TRACKING: ${REACT_APP_ENABLE_ERROR_TRACKING:-true}
        REACT_APP_SENTRY_DSN: ${REACT_APP_SENTRY_DSN}
    ports:
      - "80:80"
      - "443:443"
    environment:
      - NODE_ENV=production
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dapp.rule=Host(`supplychain.example.com`)"
      - "traefik.http.services.dapp.loadbalancer.server.port=80"
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        max_attempts: 3

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - dapp
    restart: always

volumes:
  dapp_data:

networks:
  default:
    driver: bridge

